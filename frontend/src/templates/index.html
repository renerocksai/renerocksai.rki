<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Semantische Suche in #RKIFiles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <script src="https://unpkg.com/htmx.org@1.5.0" nonce="{{ nonce }}"></script>
    <style nonce="{{ nonce }}">
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .form-container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .results-container {
            /* max-width: 800px; */
            max-width: 80%;
            width: 80%;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            /* display: none; */
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .field {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .search-div {
            margin-bottom: 20px;
            display: flex;
            flex-direction: row;
        }

        .field-horizontal {
            flex-direction: row;
            align-items: center;
        }
        .field-horizontal label {
            margin-right: 10px;
            min-width: 120px;
        }

        .slider-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        label {
            margin-right: 10px;
            font-weight: bold;
            /* color: #404040; */
            color: #808080;
        }
        input[type="text"], select, input[type="range"], input[type="checkbox"], button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="text"] {
            width: 90%;
            margin-right: 10px;
            color: red;
        }
        input[type="range"], select, button {
            flex-grow: 1;
        }
        input[type="range"] {
            margin-left: 10px;
            margin-right: 10px;
            flex-grow: 2;
        }

        output {
            min-width: 50px;
            text-align: center;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: #f9f9f9;
        }
        #results details {
            color: grey;
            width: 100%;
        }
        body #loading {
            display: none;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* individual search results */
        .search-result {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .search-result .doc-path {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .search-result .doc-path .distance{
            font-weight: normal;
            color: grey;
            margin-bottom: 10px;
        }
        .search-result pre {
            margin: 0;
            font-family: monospace;
            white-space: pre-wrap; /* Allow text to wrap inside <pre> elements */
            word-wrap: break-word; /* Ensure long words are broken to fit within the container */
        }
        .search-result a {
            word-wrap: break-word; 
        }
        .search-result .matching-line {
            /* background-color: #007bff; */
            background-color: #ff7b00;
            /* background-color: #ff2020; */
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .footer {
            margin-top: auto;
            background-color: #f8f9fa;
            text-align: center;
            padding: 20px;
            padding-left: 15%;
            padding-right: 15%;
            border-top: 1px solid #eaeaea;
            display: flex;
            flex-direction: row;
            justify-content: space-around;
        }

        .footer p {
            margin: 0;
            padding: 0;
        }

        .footer a {
            color: #007bff;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .footer .github-logo {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Semantische Suche in <a href="https://x.com/hashtag/rkifiles">#RKIFiles</a></h1>

         <form id="search-form" hx-get="/search" hx-target="#results" hx-swap="innerHTML">
            <div class="field-horizontal">
                <!-- <label for="query" style="color:black;">Suchtext</label> -->
                <div class="search-div">
                    <input type="text" id="query" name="query" placeholder="Suchtext..." required>
                    <button type="submit">Suchen</button>
                </div>
            </div>
            
            <div class="field-horizontal">
                <label for="dataset">Ordner:</label>
                <select id="dataset" name="dataset">
                    <option value="sitzungsprotokolle">Sitzungsprotokolle</option>
                    <option value="zusatzmaterial">Zusatzmaterial incl. Sitzungsprotokolle</option>
                </select>
            </div>
            
            <div class="field-horizontal slider-container">
                <label for="num_results">Anzahl Ergebnisse</label>
                <input type="range" id="num_results" name="num_results" min="1" max="500" value="10">
                <output id="num_results_output">10</output>
            </div>
            
            <div class="field-horizontal slider-container">
                <label for="result_size">Textlänge pro Ergebnis (Zeichen):</label>
                <input type="range" id="result_size" name="result_size" min="20" max="1000" value="300">
                <output id="result_size_output">300</output>
            </div>
        </form>       

        <div id="loading">
            <div class="spinner"></div>
        </div>
    </div>
    <div id="results" class="results-container results">
        <!-- Search results will be inserted here -->
        <details>
            <summary>Wie funktioniert die Semantische Suche?</summary>
        <p>
            Über eine KI können Texte in Zahlenreihen umgewandelt werden, die die Bedeutung
            eines jeweiligen Textes abbilden. Man spricht von sogenannten "Text-Embeddings".
        </p>

        <p>
            Bei jeder Suche wird der Suchtext zunächst in dieses abstrakte Embeddings-Format
            umgewandelt und so seine Bedeutung abstrakt erfasst.
        </p>

        <p>
            Die exakte Wortwahl spielt dann keine große Rolle mehr. Sogar die Sprache ist
            irrelevant. Ob nach "Ausgangssperren" oder nach "curfews" gesucht wird, ist in
            der Bedeutung egal, so auch in den Embeddings.
        </p>

        <p>
            Um die Suchtreffer zu ermitteln, werden die Embeddings des Suchtexts mit den
            Embeddings der zu durchsuchenden Textabschnitte verglichen.
        </p>

        <p>
            Zu diesem Zweck haben wir vorab alle Textstellen aus dem Leak in Embeddings
            konvertiert. So kamen insgesamt ca. 580.000 Embedding-Repräsentationen zustande.
        </p>

        <p>
            Zur Darstellung der Ergebnisse werden zu jedem Treffer schlussendlich noch
            umliegende Textabschnitte (meist: Zeilen) mit einbezogen, bis die gewünschte
            Ergebnis-Länge erreicht ist. Die gefundenen Stellen werden dabei gesondert
            hervorgehoben.
        </p>

    </div>
    <div class="footer">
        <div> &copy; 2024 <a href="https://x.com/renerocksai" target="_blank">@renerocksai</a></div>
        <a href="https://github.com/renerocksai/renerocksai.rki" target="_blank">
            <img src="{{ url_for('static', filename='github-mark.svg') }}" alt="GitHub" class="github-logo">
            rki-slurp on GitHub
        </a>
    </div>
    <script nonce="{{ nonce }}">
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('num_results').addEventListener('input', function() {
                document.getElementById('num_results_output').value = this.value;
            });
            document.getElementById('result_size').addEventListener('input', function() {
                document.getElementById('result_size_output').value = this.value;
            });
        });

       document.body.addEventListener('htmx:configRequest', function(evt) {
            document.getElementById('results').innerHTML = '';  // Clear the current results
            document.getElementById('loading').style.display = 'flex';
        });
        
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
        });
    </script>
</body>
</html>
